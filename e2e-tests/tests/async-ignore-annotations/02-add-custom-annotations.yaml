apiVersion: kuttl.dev/v1beta1
kind: TestStep
commands:
  - script: |-
      set -o errexit
      set -o xtrace

      source ../../functions
      mysql_svc=$(get_mysql_service async-ignore-annotations)
      haproxy_svc=$(get_haproxy_svc async-ignore-annotations)
      orc_svc=$(get_orc_svc async-ignore-annotations)

      kubectl get svc  $mysql_svc-0 -o yaml -n "${NAMESPACE}" \
      	| yq eval '.metadata.annotations = {"async-ignore-annotations-mysql": "true"} + .metadata.annotations ' - \
      	| yq eval '.metadata.annotations = {"async-not-ignore-annotations-mysql": "true"} + .metadata.annotations ' - \
      	| yq eval '.metadata.labels = {"async-ignore-labels-mysql": "true"} + .metadata.labels ' - \
        | yq eval '.metadata.labels = {"async-not-ignore-labels-mysql": "true"} + .metadata.labels ' - \
        | kubectl -n "${NAMESPACE}" apply -f -

      kubectl get svc  $haproxy_svc -o yaml -n "${NAMESPACE}"\
        | yq eval '.metadata.annotations = {"async-ignore-annotations-haproxy": "true" } + .metadata.annotations ' - \
        | yq eval '.metadata.annotations = {"async-not-ignore-annotations-haproxy": "true" } + .metadata.annotations ' - \
        | yq eval '.metadata.labels = {"async-ignore-labels-haproxy": "true"} + .metadata.labels ' - \
        | yq eval '.metadata.labels = {"async-not-ignore-labels-haproxy": "true" } + .metadata.labels ' - \
        | kubectl -n "${NAMESPACE}" apply -f -

      kubectl get svc  $orc_svc-0 -o yaml -n "${NAMESPACE}"\
        | yq eval  '.metadata.annotations = {"async-ignore-annotations-orc": "true" } + .metadata.annotations ' - \
        | yq eval '.metadata.annotations = {"async-not-ignore-annotations-orc": "true" } + .metadata.annotations ' - \
        | yq eval '.metadata.labels = {"async-ignore-labels-orc": "true" } + .metadata.labels ' - \
        | yq eval '.metadata.labels = {"async-not-ignore-labels-orc": "true" } + .metadata.labels ' - \
        | kubectl -n "${NAMESPACE}" apply -f -

    timeout: 100
